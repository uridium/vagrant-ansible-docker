- name: Virtual environments
  become: yes
  hosts: devel
  tasks:
    ## apt-key adv --keyserver p80.pool.sks-keyservers.net --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
    - name: Add Docker repository key
      tags: repo
      apt_key:
        keyserver: p80.pool.sks-keyservers.net
        id: 58118E89F3A912897C070ADBF76221572C52609D

    - name: Add Docker repository file
      tags: repo
      apt_repository:
        repo: deb https://apt.dockerproject.org/repo ubuntu-trusty main
        filename: docker

    - name: Get kernel version
      tags: packages
      command: uname -r
      register: kernel_release
      changed_when: False

    - name: Install kernel extra modules
      tags: packages
      apt:
        update_cache: yes
        name:
          - linux-image-extra-{{ kernel_release.stdout }}

    - name: Install docker and requirements
      tags: packages
      apt:
        update_cache: no
        name:
          - docker-engine
          - python-pip

    - name: Install docker-py
      tags: packages
      pip:
        name: docker-py
        version: 1.10.6

    - name: Add vagrant user to docker group
      tags: environment
      user:
        name: vagrant
        groups: docker

    - name: Create redis volume
      tags: containers
      command: docker volume create --name redis-data
      args:
        creates: /var/lib/docker/volumes/redis-data

    ## docker build -t app-image /home/vagrant/app
    - name: Build application image
      tags: containers
      docker_image:
        name: app-image
        path: /home/vagrant/app

    ## docker run -d --restart=always --name=redis-service -p 0.0.0.0:6379:6379 -v redis-data:/data redis:3 redis-server --appendonly yes
    - name: Run redis
      tags: containers
      docker:
        name: redis-service
        image: redis:3
        restart_policy: always
        command: redis-server --appendonly yes
        expose:
          - 6379
        ports:
          - 0.0.0.0:6379:6379
        volumes:
          - redis-data:/data

    ## docker run -d --restart=always --name=app-service -p 0.0.0.0:5000:5000 -v /home/vagrant/app:/usr/local/app --link=redis-service:redis-addr -e 'REDIS_SERVER=redis-addr' app-image
    - name: Run application
      tags: containers
      docker:
        name: app-service
        image: app-image
        restart_policy: always
        expose:
          - 5000
        ports:
          - 0.0.0.0:5000:5000
        volumes:
          - /home/vagrant/app:/usr/local/app
        links:
          - redis-service:redis-addr
        env:
          REDIS_SERVER: redis-addr
